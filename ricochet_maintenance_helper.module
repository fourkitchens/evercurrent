<?php

/**
 * @file
 * Contains ricochet_maintenance_helper.module.
 */

use Drupal\Core\Routing\RouteMatchInterface;
use Drupal\ricochet_maintenance_helper\UpdateHelper;

/**
 * Default target environment
 */
const RMH_ENV_URL = 'http://maintenance.projectricochet.com';

/**
 * Module's API version.
 */
const RMH_API_VERSION = 2;

/**
 * MD5 hash used for keys.
 */
const RMH_MD5_MATCH = '/^[a-f0-9]{32}$/i';

/**
 * Server update url.
 */
const RMH_URL = '/ricochet-maintenance/post-update';

/**
 * The current status of the module operation.
 */
const RMH_STATUS = 'ricochet_maintenance_helper_status';

/**
 * Module operation: Status OK.
 * Under normal circumstances.
 */
const RMH_STATUS_OK = 0;
const RMH_STATUS_WARNING = 1;
const RMH_STATUS_ERROR = 2;

/**
 * Module status message
 *
 * Used to display current status in the status page.
 */
const RMH_STATUS_MESSAGE = 'status_message';

/**
 * Implements hook_cron().
 */
function ricochet_maintenance_helper_cron() {
  $config = \Drupal::config('ricochet_maintenance_helper.admin_config');
  // Check if we are to send updates now.
  if ($config->get('send')) {
    $last_run = Drupal::state()->get('ricochet_maintenance_helper_last_run') ?: 0;
    $interval = $config->get('interval');
    // Check if last run plus interval is earlier than now
    if (($last_run + $interval) < time()) {
      /** @var UpdateHelper $updateHelper */
      $updateHelper = \Drupal::service('ricochet_maintenance_helper.update_helper');
      $updateHelper->sendUpdates(TRUE);
    }
  }
}